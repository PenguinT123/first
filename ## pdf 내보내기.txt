## pdf ë‚´ë³´ë‚´ê¸°
if st.button("ğŸ“„ PDFë¡œ ë‚´ë³´ë‚´ê¸°"):

    df = st.session_state.grade_data.copy()
    df_reset = df.reset_index()  # ê³¼ëª©ì´ ì¸ë±ìŠ¤ì— ìˆì„ ê²½ìš° ëŒ€ë¹„

    # ì‚°ì¶œ ë°©ì‹ì´ ì„ íƒë˜ì§€ ì•Šì•˜ì„ ê²½ìš° "ì „ì²´" ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
    if "converted" not in st.session_state or "average" not in st.session_state:
        avg = calculate_filtered_average(df, selected_semesters, "ì „ì²´")
        conv = calculate_converted_score(df, selected_semesters, include_etc=True)
        reco = recommend_universities(conv)
    else:
        avg = st.session_state.average
        conv = st.session_state.converted
        reco = st.session_state.recommendation

    # ê³¼ëª©ë³„ í‰ê·  ë“±ê¸‰ ê³„ì‚°
    subject_averages = {}
    for subject, row in df.iterrows():
        grades = [row[sem] for sem in selected_semesters if pd.notna(row[sem])]
        if grades:
            subject_averages[subject] = round(sum(grades) / len(grades), 2)

    subject_avg_html = ""
    if subject_averages:
        subject_avg_html = "<h2>ğŸ“Š ê³¼ëª©ë³„ í‰ê·  ë“±ê¸‰</h2><table border='1'><tr><th>ê³¼ëª©</th><th>í‰ê·  ë“±ê¸‰</th></tr>"
        for subj, avg_score in subject_averages.items():
            subject_avg_html += f"<tr><td>{subj}</td><td>{avg_score}</td></tr>"
        subject_avg_html += "</table>"

    # ì „ì²´ HTML ì½˜í…ì¸  ë™ì  ìƒì„±
    table_html = df_reset.to_html(index=False, border=1)

    html_content = f"""
    <html>
    <head>
        <meta charset="utf-8">
        <style>
            body {{ font-family: "Malgun Gothic", sans-serif; }}
            h1, h2 {{ text-align: center; }}
            table {{ border-collapse: collapse; width: 100%; margin-bottom: 30px; }}
            th, td {{ border: 1px solid black; padding: 8px; text-align: center; }}
        </style>
    </head>
    <body>
        <h1>ë‚´ì‹  ì„±ì í‘œ</h1>
        {table_html}

        <h2>ğŸ“ˆ ì‚°ì¶œ ê²°ê³¼</h2>
        <p><strong>í‰ê·  ë“±ê¸‰:</strong> {avg}</p>
        <p><strong>í™˜ì‚° êµê³¼ ì ìˆ˜:</strong> {conv}ì </p>
        <p><strong>ì¶”ì²œ ëŒ€í•™ ë¼ì¸:</strong> {reco}</p>

        {subject_avg_html}
    </body>
    </html>
    """

    # PDFë¡œ ë³€í™˜
    if st.button("ğŸ“„ HTMLë¡œ ë‚´ë³´ë‚´ê¸°"):
        st.download_button(
            label="ğŸ“„ HTML ë‹¤ìš´ë¡œë“œ",
            data=html_content,
            file_name="ë‚´ì‹ ì„±ì í‘œ.html",
            mime="text/html"
            )

    #with tempfile.NamedTemporaryFile(delete=False, suffix=".pdf") as tmpfile:
    #    config = pdfkit.configuration(wkhtmltopdf="C:/Program Files/wkhtmltopdf/bin/wkhtmltopdf.exe")
    #    pdfkit.from_string(html_content, tmpfile.name, configuration=config)
    #    with open(tmpfile.name, "rb") as f:
    #        st.download_button("ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ", f, file_name="ë‚´ì‹ ì„±ì í‘œ.pdf")